#! /bin/bash
ROOT=`cd $(dirname $0); pwd`
CONFDIR=$ROOT/config

source ./config/env.conf

# å®šä¹‰erlang vmé€‰é¡¹
ERL=/usr/local/bin/erl
DATETIME=`date "+%Y%m%d-%H%M%S"`
export ERL_CRASH_DUMP=$ROOT/erl_crash_$DATETIME.dump
export ERL_MAX_PORTS=102400
export ERL_MAX_ETS_TABLES=10000
export HOME=$ROOT
export LOG_DIR=$ERRLOGDIR
SYSTEM_CONF_FILE=$CONFDIR/game_server

NET_TICKTIME=600

# è¿è¡Œçš„ç¨‹åºåŠæ§åˆ¶æ–‡ä»¶
APP_MOD=main
APP_CTL=game_ctl
# define additional environment variables
# ä¿®æ”¹å¼•ç”¨ç›®å½•
if [ "$EBINS" == "" ]; then
    EBINS="$ROOT/ebin"
fi

STATUS_SUCCESS=0    # æˆåŠŸ
STATUS_NORUN=1      # æœªè¿è¡Œ
STATUS_USAGE=2      # ä½¿ç”¨é”™è¯¯
STATUS_BADRPC=3     # rpcè°ƒç”¨é”™è¯¯
STATUS_ERROR=4      # å…¶å®ƒé”™è¯¯
STATUS_STARTING=5   # æ­£åœ¨å¼€æœä¸­
STATUS_RUNNING=6    # è¿è¡Œä¸­
STATUS_STOPING=7    # æ­£åœ¨å…³æœä¸­

CTL_STATUS_NORUN=0
CTL_STATUS_STARTING=1
CTL_STATUS_RUNNING=2
CTL_STATUS_STOPING=3
CTL_STATUS_ERROR=4

# æ‰“å°é”™è¯¯
error() {
    echo -e "[1;41m[é”™è¯¯][`date +"%F %T"`][0m [${ERLANG_NODE}]$1"
    exit 1
}

# æ‰“å°ä¿¡æ¯
echo2() {
    echo -e "[1;42m[æ“ä½œ][`date +"%F %T"`][0m [${ERLANG_NODE}]$1"
}

# æ‰“å°ä¿¡æ¯(ä¸æ¢è¡Œ)
echo2_n() {
    echo -n -e "[1;42m[æ“ä½œ][`date +"%F %T"`][0m [${ERLANG_NODE}]$1"
}

# æ‰“å°è­¦å‘Š
warn() {
    echo -e "[1;43m[è­¦å‘Š][`date +"%F %T"`][0m [${ERLANG_NODE}]$1"
}

# ä½¿ç”¨è¯´æ˜
usage ()
{
    echo ""
    echo "ç”¨æ³•:"
    echo "$0 ACTION [OPTION]"
    echo "ACTION:"
    echo "  live            äº¤äº’æ–¹å¼å¯åŠ¨"
    echo "  start           åå°æ–¹å¼å¯åŠ¨"
    echo "  async_start     åå°æ–¹å¼å¯åŠ¨(å¼‚æ­¥)" 
    echo "  status          è·å–åå°è¿è¡ŒçŠ¶æ€"
    echo "  attach          é€šè¿‡Erlang shellè¿æ¥åå°è¿è¡ŒèŠ‚ç‚¹"
    echo "  stop            ç«‹å³åœæ­¢èŠ‚ç‚¹(åŒæ­¥)"
    echo "  sync_stop       åŒæ­¥åœæ­¢èŠ‚ç‚¹(åŒæ­¥)"
	echo "  safe_stop       åŒæ­¥åœæ­¢èŠ‚ç‚¹(ç¼“å­˜åŒæ­¥åˆ°æ•°æ®åº“)"
    echo "  restart         é‡å¯èŠ‚ç‚¹"
	echo "  hotup          	æ‰§è¡Œçƒ­æ›´æ–°"
    echo "  config          é‡æ–°åŠ è½½é…ç½®"
    echo "  count           è·å–åœ¨çº¿äººæ•°"
    echo "  version         è·å–ç‰ˆæœ¬ä¿¡æ¯"
    echo "  check_db        æ£€æŸ¥æ¸¸æˆæœæ•°æ®çŠ¶æ€[æœªæ”¯æŒ]"
    echo ""
    echo "OPTION:"
    echo "  -h, --help              æ˜¾ç¤ºæœ¬ä¿¡æ¯"
    echo "  -s, --smp=true          æ˜¯å¦ä½¿ç”¨smp(true|false,é»˜è®¤ä¸ºtrue)"
    echo "  -c, --cookie=Cookie     èŠ‚ç‚¹cookie(é»˜è®¤\"\")"
    echo "  -f, --conf=Conf         æŒ‡æ˜ä½¿ç”¨çš„é…ç½®æ–‡ä»¶(é»˜è®¤game.conf)"
    echo ""
}

# ä¿®æ”¹ulimit
change_ulimit() {
    if ! ulimit -HSn 102400 2> /dev/null ; then
        ## error "è¯·ç¡®ä¿å…·æœ‰rootæƒé™"
        echo "è¯·ç¡®ä¿å…·æœ‰rootæƒé™"
    fi
}

# æŸ¥è¯¢è¿è¡Œä¸­èŠ‚ç‚¹çš„ä¿¡æ¯
rpc() 
{
    $ERL \
      $NAME_FLAG ${CTL_NAME}_ctl@$HOST \
      -noinput \
      -pa $EBINS \
	    -config $SYSTEM_CONF_FILE \
      -setcookie ${COOKIE} \
      -s ${APP_CTL} -extra $ERLANG_NODE $@
}

# æ‰“å°rpcè¿”å›ä¿¡æ¯
print_rpc_return ()
{
    case $1 in
    $STATUS_SUCCESS) 
        echo ""
        ;;
    $STATUS_NORUN) 
        warn "æœªè¿è¡Œ!"
        ;;
    $STATUS_USAGE) 
        error "å‘½ä»¤ä¸æ”¯æŒ! $0 -hæŸ¥çœ‹å¸®åŠ©"
        ;;
    $STATUS_BADRPC) 
        error "RPCå‘ç”Ÿé”™è¯¯"
        ;;
    $STATUS_ERROR) 
        error "è¯·æ±‚å‘ç”Ÿé”™è¯¯"
        ;;
    $STATUS_STARTING) 
        echo2 "æ­£åœ¨å¼€æœä¸­"
        ;;
    $STATUS_RUNNING) 
        echo2 "è¿è¡Œä¸­"
        ;;
    $STATUS_STOPING) 
        echo2 "æ­£åœ¨åœæœä¸­"
        ;;
    *)
        error "æœªçŸ¥å‘½ä»¤! $0 -hæŸ¥çœ‹å¸®åŠ©"
    esac
    exit $1
}

# åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦è¿è¡Œ
is_started () 
{
    rpc status
    result=$?
    if [  "$result" = "$STATUS_RUNNING" ]; then
        return 0
    fi
    return $result
}

# åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦è¿è¡Œ
is_stop () 
{
    rpc status
    result=$?
    if [  "$result" = "$STATUS_NORUN" ]; then
        return 0
    fi
    return $result
}

# åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦crash
is_crashed() 
{
    if [ -f ${ERL_CRASH_DUMP} ]; then
        return 0
    fi
    return 1
}

# start interactive server
live ()
{
    change_ulimit
    $ERL \
      $NAME_FLAG $ERLANG_NODE \
      -pa $EBINS \
      -setcookie ${COOKIE} \
	    -config ${SYSTEM_CONF_FILE} \
      -s ${APP_MOD} start \
      $ERLANG_OPTS --extra $ARGS "$@"
}

# å¯åŠ¨server
start ()
{
    change_ulimit
    /bin/rm -rf logs
    ensure_log_dir
    if is_started; then
        warn "èŠ‚ç‚¹$ERLANG_NODEå·²ç»å¯åŠ¨"
        exit 0
    fi

    echo2_n "å¼€å§‹å¯åŠ¨" 
    # ç­‰å¾…1ç§’é’Ÿ
    sleep 1
    $ERL \
      $NAME_FLAG $ERLANG_NODE \
      -noinput -detached \
      -hidden \
      -pa $EBINS \
      -setcookie ${COOKIE} \
      -kernel error_logger silent \
      -sasl sasl_error_logger \{file,\"$SASL_LOG\"\} \
	    -config ${SYSTEM_CONF_FILE} \
      -kernel inet_dist_listen_min 41000 inet_dist_listen_max 42000 \
	  -kernel net_ticktime $NET_TICKTIME \
      -s ${APP_MOD} start \
      $ERLANG_OPTS $ARGS "$@"
    
    if [ "$1" = "async" ]; then
        echo ""
        echo2 "å¯åŠ¨ä¸­ï¼Œè¯·ç¨å€™é€šè¿‡$0 statusæ£€æµ‹"
        [ -f normal.stop ] && /bin/rm normal.stop
        exit 0
    fi

    RETRY=0
    while true; do
        if [ $? -ne 0 ]; then
            echo ""
            error "å¯åŠ¨å¤±è´¥:$?"
        else
            if is_started; then
                break
            fi
            if is_crashed; then
                echo ""
                error "å¯åŠ¨å¤±è´¥,å‘ç”Ÿcrash!"
            else
                let RETRY++
                echo -n "."
                sleep 1
            fi
            if [ $RETRY -gt 180 ];then
                error "å¯åŠ¨è¶…æ—¶"
            fi
        fi
    done
    echo ""
    [ -f "normal.stop" ] && /bin/rm normal.stop
    echo2 "å¯åŠ¨æˆåŠŸ"
}

# è·å–çŠ¶æ€
status ()
{
    if is_started; then
        echo2 "è¿è¡Œä¸­"
    else
        print_rpc_return $?
    fi  
}

# è¿æ¥åˆ°èŠ‚ç‚¹å†…
attach ()
{
    if ! is_started; then
        error "[$ERLANG_NODE]æœªå¯åŠ¨"
    fi
    $ERL \
      $NAME_FLAG ${NAME}_attach@$HOST \
      -setcookie ${COOKIE} \
	  -kernel net_ticktime $NET_TICKTIME \
      -remsh $ERLANG_NODE \
      $ERLANG_OPTS $ARGS "$@"
}

# åœæ­¢èŠ‚ç‚¹
stop ()
{
    if rpc stop ; then
        echo2 "åœæ­¢"
        touch normal.stop
    else
        print_rpc_return $?
    fi  
}

# åœæ­¢èŠ‚ç‚¹
sync_stop ()
{
    if rpc stop ; then
        echo2 "åœæ­¢"
        RETRY=0
        while true; do
            if is_stop; then
                break
            elif [ $RETRY -gt 30 ];then
                break
            fi
            let RETRY++
            echo -n "."
            sleep 1
        done
        echo ""
        echo2 "åœæ­¢æˆåŠŸ"
        touch normal.stop
    else
        print_rpc_return $?
    fi  
}

# åœæ­¢èŠ‚ç‚¹ï¼Œç¼“å­˜æ•°æ®åŒæ­¥åˆ°æ•°æ®åº“
safe_stop ()
{
    if rpc safe_stop ; then
        echo2 "åœæ­¢"
        RETRY=0
        while true; do
            if is_stop; then
                break
            elif [ $RETRY -gt 30 ];then
                break
            fi
            let RETRY++
            echo -n "."
            sleep 1
        done
        echo ""
        echo2 "åœæ­¢æˆåŠŸ"
        touch normal.stop
    else
        print_rpc_return $?
    fi  
}

# é‡å¯èŠ‚ç‚¹
restart ()
{
    sync_stop
    sleep 3
    start
}

# æ‰§è¡Œçƒ­æ›´æ–°
hotup ()
{
    if rpc hotup; then
        echo2 "çƒ­æ›´æ–°æˆåŠŸ"
    else
        error "çƒ­æ›´æ–°å¤±è´¥"
    fi  
}

# é‡æ–°åŠ è½½é…ç½®
config ()
{
    if rpc reload_config; then
        echo2 "çƒ­æ›´é…ç½®æˆåŠŸ"
    else
        error "çƒ­æ›´é…ç½®å¤±è´¥"
    fi  
}

# è·å–åœ¨çº¿äººæ•°
count ()
{
    if ! is_started; then
        echo 0
        exit 0
    fi
    rpc count
}


# è·å–ç‰ˆæœ¬ä¿¡æ¯
version ()
{
    if ! is_started; then
        echo 0
        exit 0
    fi
    rpc version
}

# æ•°æ®åº“çŠ¶æ€
check_db ()
{
    if ! is_started; then
        echo 0
        exit 0
    fi
    if rpc check_db;then
        echo2 "æ•°æ®åº“è¿æ¥æˆåŠŸ"
    else
        error "æ•°æ®è¿æ¥å¤±è´¥"
    fi
}



# parse command line parameters
while [ $# -ne 0 ] ; do
    PARAM=$1
    shift
    case $PARAM in
        --) break ;;
        --cookie|-c) COOKIE=$1 ; shift ;;
        --conf|-f) 
            #GAME_CONF_FILE=$CONFDIR/${1##*/};
            GAME_CONF_FILE=$1;
            export GAME_CONF_FILE=${GAME_CONF_FILE}; 
            shift ;;
        --help|-h) usage; exit 0;;
        *) ARGS="$ARGS $PARAM" ;;
    esac
done

# èŠ‚ç‚¹å
ERLANG_NODE=${NAME}@${HOST}
TIMESTAMP=`date "+%Y%m%d-%H%M%S_%N"`
CTL_NAME=${NAME}"_"${TIMESTAMP}
NAME_FLAG=-name

if [ -f "./smp" ];then
    SMP=`cat ./smp`
else
    SMP="enable"
fi

ERLANG_OPTS="-connect_all false +K true -smp $SMP +P 5000000 \
    +t 16777216 +fnu +hms 8192 +hmbs 8192 +zdbbl 81920 -v"

# makesure the logs dir exists
ensure_log_dir()
{
    if [ ! -d $ERRLOGDIR ]; then
        mkdir -p $ERRLOGDIR || (echo "make $ERRLOGDIR error!"; exit 1)
    fi
    SASL_LOG=$ERRLOGDIR/${ERLANG_NODE}_${DATETIME}.sasl
}


case $ARGS in
    '') usage;;
    ' live') live;;
    ' start') start sync;;
    ' async_start') start async;;
    ' status') status;;
    ' attach') attach;;
    ' stop') stop;;
    ' sync_stop') sync_stop;;
	' safe_stop') safe_stop;;
    ' restart') restart;;
    ' count') count;;
    ' config') config;;
	' hotup') hotup;;
    ' version') version;;
    ' check_db') check_db;;
    *) usage; exit 1
esac
